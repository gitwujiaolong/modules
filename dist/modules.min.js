/*!
 * web-moduels v1.0.0
 * Copyright 2014-2015 
 * Licensed under MIT
 * Include HTMLElement,XMLHttpRequest,CustomEvent,EventPath,logForBrowser,jweixin,citySelect,formJSON,shareWX 
 * Update on 2015-10-19 08:49;42 
 */


// For android 4.4-
if (HTMLElement && !HTMLElement.prototype.remove) {
  HTMLElement.prototype.remove = function() {
    this.parentNode.removeChild(this);
  };
}

if (HTMLElement && !HTMLElement.prototype.click) {
  HTMLElement.prototype.click = function() {
    this.dispatchEvent(new Event('click', {bubbles: true}));
  }
}

/**
 *
 * WHY?
 * @see  http://caniuse.com/#search=xml
 * Android 4.3- not supporting json as responseType
 *
 * HOW?
 * @see  https://github.com/Financial-Times/polyfill-service/blob/master/polyfills/XMLHttpRequest/polyfill.js
 *
 */

(function(global, NativeXMLHttpRequest) {

  var testTypeJSON = true;

  try {
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open('GET', '/', true);
    xmlHttp.responseType = 'json';
  } catch (e) {

    testTypeJSON = false;
  }

  if (!testTypeJSON) {


      // <Global>.XMLHttpRequest
    global.XMLHttpRequest = function XMLHttpRequest() {
      var request = this, nativeRequest = request._request = new NativeXMLHttpRequest();

      nativeRequest.onreadystatechange = function () {
        request.readyState = nativeRequest.readyState;

        var readyState = request.readyState === 4;

        request.response = request.responseText = readyState ? nativeRequest.responseText : null;
        request.status = readyState ? nativeRequest.status : null;
        request.statusText = readyState ? nativeRequest.statusText : null;

        // support responseType is json.
        if (request.response && request.responseType === 'json') {
          try {
            request.response = JSON.parse(request.response);
          } catch (e) {}
        }

        // request.dispatchEvent(new Event('readystatechange'));
        request.onreadystatechange && request.onreadystatechange();

        if (readyState) {

          // request.dispatchEvent(new Event('load'));
          request.onload && request.onload();
        }
      };

      if ('onerror' in nativeRequest) {
        nativeRequest.onerror = function () {
          // request.dispatchEvent(new Event('error'));
          request.onerror && request.onerror();
        };
      }
    };

    var XMLHttpRequestPrototype = global.XMLHttpRequest.prototype;

    XMLHttpRequestPrototype.addEventListener = global.addEventListener;
    XMLHttpRequestPrototype.removeEventListener = global.removeEventListener;
    XMLHttpRequestPrototype.dispatchEvent = global.dispatchEvent;

    XMLHttpRequestPrototype.abort = function abort() {
      // return this._request();
      return this._request.abort();
    };

    XMLHttpRequestPrototype.getAllResponseHeaders = function getAllResponseHeaders() {
      return this._request.getAllResponseHeaders();
    };

    XMLHttpRequestPrototype.getResponseHeader = function getResponseHeader(header) {
      return this._request.getResponseHeader(header);
    };

    XMLHttpRequestPrototype.open = function open(method, url) {
      // method, url, async, username, password
      this._request.open(method, url, arguments[2], arguments[3], arguments[4]);
    };

    XMLHttpRequestPrototype.overrideMimeType = function overrideMimeType(mimetype) {
      this._request.overrideMimeType(mimetype);
    };

    XMLHttpRequestPrototype.send = function send() {
      this._request.send(0 in arguments ? arguments[0] : null);
    };

    XMLHttpRequestPrototype.setRequestHeader = function setRequestHeader(header, value) {
      this._request.setRequestHeader(header, value);
    };
  }

})(this, this.XMLHttpRequest);

/**
 * WHY?
 * @see http://caniuse.com/#feat=customevent
 *
 * HOW?
 * @see  https://github.com/Financial-Times/polyfill-service/blob/master/polyfills/Event/polyfill.js
 *
 */

(function(global){

  var ok = function() {

    // Android 4.3- not support customEvent, but reuturn ture.
    // KTouch android/4.3
    // Nexus android 4.3
    var ua = global.navigator.userAgent.toLowerCase();
    if (ua.indexOf('android/4.3') !== -1 || ua.indexOf('android/4.2') !== -1 || ua.indexOf('android/4.1') !== -1 ||
        ua.indexOf('android 4.3') !== -1 || ua.indexOf('android 4.2') !== -1 || ua.indexOf('android 4.1') !== -1) {
      return false;
    }

    if (!('Event' in global)) return false;
    if (typeof global.Event === 'function') return true;

    try {

      // In IE 9 and 10, the Event object exists but cannot be instantiated
      new Event('click');
      return true;
    } catch(e) {
      return false;
    }
  }

  if (!ok()) {

    global.Event = function Event(type, eventInitDict) {
      if (!type) {
        throw new Error('Not enough arguments');
      }

      var
      event = document.createEvent('Event'),
      bubbles = eventInitDict && eventInitDict.bubbles !== undefined ? eventInitDict.bubbles : false,
      cancelable = eventInitDict && eventInitDict.cancelable !== undefined ? eventInitDict.cancelable : false;

      event.initEvent(type, bubbles, cancelable);

      return event;
    };
  }

  /* Fix */
  document.addEventListener('webkitAnimationEnd', function(e) {

    if (!e._fix) {
      var eve = new Event('animationend', {bubbles: true});
      eve._fix = true;

      e.target.dispatchEvent(eve);
    }
  })

})(window);

(function(global){

  // For Android 4.3- (included)
  document.body.addEventListener('click', function(e) {
    if (!e.path) {
      e.path = [];
      var t = e.target;
      while (t !== document) {
        e.path.push(t);
        t = t.parentNode;
      }
      e.path.push(document);
      e.path.push(window);
    }
  }, true)

})(window);


(function(){

  window.onerror = function(msg, file, line) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", '/log', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.send(JSON.stringify({
      msg: navigator.userAgent + '\n' + location.href + '\n' + file + ':' + line + '\n' + msg
    }));
  }

})(window);

!function(a,b){"function"==typeof define&&(define.amd||define.cmd)?define('jweixin',[],function(){return b(a)}):b(a,!0)}(this,function(a,b){function c(b,c,d){a.WeixinJSBridge?WeixinJSBridge.invoke(b,e(c),function(a){g(b,a,d)}):j(b,d)}function d(b,c,d){a.WeixinJSBridge?WeixinJSBridge.on(b,function(a){d&&d.trigger&&d.trigger(a),g(b,a,c)}):d?j(b,d):j(b,c)}function e(a){return a=a||{},a.appId=z.appId,a.verifyAppId=z.appId,a.verifySignType="sha1",a.verifyTimestamp=z.timestamp+"",a.verifyNonceStr=z.nonceStr,a.verifySignature=z.signature,a}function f(a){return{timeStamp:a.timestamp+"",nonceStr:a.nonceStr,"package":a.package,paySign:a.paySign,signType:a.signType||"SHA1"}}function g(a,b,c){var d,e,f;switch(delete b.err_code,delete b.err_desc,delete b.err_detail,d=b.errMsg,d||(d=b.err_msg,delete b.err_msg,d=h(a,d),b.errMsg=d),c=c||{},c._complete&&(c._complete(b),delete c._complete),d=b.errMsg||"",z.debug&&!c.isInnerInvoke&&alert(JSON.stringify(b)),e=d.indexOf(":"),f=d.substring(e+1)){case"ok":c.success&&c.success(b);break;case"cancel":c.cancel&&c.cancel(b);break;default:c.fail&&c.fail(b)}c.complete&&c.complete(b)}function h(a,b){var e,f,c=a,d=p[c];return d&&(c=d),e="ok",b&&(f=b.indexOf(":"),e=b.substring(f+1),"confirm"==e&&(e="ok"),"failed"==e&&(e="fail"),-1!=e.indexOf("failed_")&&(e=e.substring(7)),-1!=e.indexOf("fail_")&&(e=e.substring(5)),e=e.replace(/_/g," "),e=e.toLowerCase(),("access denied"==e||"no permission to execute"==e)&&(e="permission denied"),"config"==c&&"function not exist"==e&&(e="ok"),""==e&&(e="fail")),b=c+":"+e}function i(a){var b,c,d,e;if(a){for(b=0,c=a.length;c>b;++b)d=a[b],e=o[d],e&&(a[b]=e);return a}}function j(a,b){if(!(!z.debug||b&&b.isInnerInvoke)){var c=p[a];c&&(a=c),b&&b._complete&&delete b._complete,console.log('"'+a+'",',b||"")}}function k(){if(!("6.0.2">w||y.systemType<0)){var b=new Image;y.appId=z.appId,y.initTime=x.initEndTime-x.initStartTime,y.preVerifyTime=x.preVerifyEndTime-x.preVerifyStartTime,C.getNetworkType({isInnerInvoke:!0,success:function(a){y.networkType=a.networkType;var c="https://open.weixin.qq.com/sdk/report?v="+y.version+"&o="+y.isPreVerifyOk+"&s="+y.systemType+"&c="+y.clientVersion+"&a="+y.appId+"&n="+y.networkType+"&i="+y.initTime+"&p="+y.preVerifyTime+"&u="+y.url;b.src=c}})}}function l(){return(new Date).getTime()}function m(b){t&&(a.WeixinJSBridge?b():q.addEventListener&&q.addEventListener("WeixinJSBridgeReady",b,!1))}function n(){C.invoke||(C.invoke=function(b,c,d){a.WeixinJSBridge&&WeixinJSBridge.invoke(b,e(c),d)},C.on=function(b,c){a.WeixinJSBridge&&WeixinJSBridge.on(b,c)})}var o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;if(!a.jWeixin)return o={config:"preVerifyJSAPI",onMenuShareTimeline:"menu:share:timeline",onMenuShareAppMessage:"menu:share:appmessage",onMenuShareQQ:"menu:share:qq",onMenuShareWeibo:"menu:share:weiboApp",onMenuShareQZone:"menu:share:QZone",previewImage:"imagePreview",getLocation:"geoLocation",openProductSpecificView:"openProductViewWithPid",addCard:"batchAddCard",openCard:"batchViewCard",chooseWXPay:"getBrandWCPayRequest",startSearchBeacons:"startMonitoringBeacons",stopSearchBeacons:"stopMonitoringBeacons",onSearchBeacons:"onBeaconsInRange"},p=function(){var b,a={};for(b in o)a[o[b]]=b;return a}(),q=a.document,r=q.title,s=navigator.userAgent.toLowerCase(),t=-1!=s.indexOf("micromessenger"),u=-1!=s.indexOf("android"),v=-1!=s.indexOf("iphone")||-1!=s.indexOf("ipad"),w=function(){var a=s.match(/micromessenger\/(\d+\.\d+\.\d+)/)||s.match(/micromessenger\/(\d+\.\d+)/);return a?a[1]:""}(),x={initStartTime:l(),initEndTime:0,preVerifyStartTime:0,preVerifyEndTime:0},y={version:1,appId:"",initTime:0,preVerifyTime:0,networkType:"",isPreVerifyOk:1,systemType:v?1:u?2:-1,clientVersion:w,url:encodeURIComponent(location.href)},z={},A={_completes:[]},B={state:0,res:{}},m(function(){x.initEndTime=l()}),C={config:function(a){z=a,j("config",a);var b=z.check===!1?!1:!0;m(function(){var a,d,e;if(b)c(o.config,{verifyJsApiList:i(z.jsApiList)},function(){A._complete=function(a){x.preVerifyEndTime=l(),B.state=1,B.res=a},A.success=function(){y.isPreVerifyOk=0},A.fail=function(a){A._fail?A._fail(a):B.state=-1};var a=A._completes;return a.push(function(){z.debug||k()}),A.complete=function(){for(var c=0,d=a.length;d>c;++c)a[c]();A._completes=[]},A}()),x.preVerifyStartTime=l();else{for(B.state=1,a=A._completes,d=0,e=a.length;e>d;++d)a[d]();A._completes=[]}}),z.beta&&n()},ready:function(a){0!=B.state?a():(A._completes.push(a),!t&&z.debug&&a())},error:function(a){"6.0.2">w||(-1==B.state?a(B.res):A._fail=a)},checkJsApi:function(a){var b=function(a){var c,d,b=a.checkResult;for(c in b)d=p[c],d&&(b[d]=b[c],delete b[c]);return a};c("checkJsApi",{jsApiList:i(a.jsApiList)},function(){return a._complete=function(a){if(u){var c=a.checkResult;c&&(a.checkResult=JSON.parse(c))}a=b(a)},a}())},onMenuShareTimeline:function(a){d(o.onMenuShareTimeline,{complete:function(){c("shareTimeline",{title:a.title||r,desc:a.title||r,img_url:a.imgUrl||"",link:a.link||location.href,type:a.type||"link",data_url:a.dataUrl||""},a)}},a)},onMenuShareAppMessage:function(a){d(o.onMenuShareAppMessage,{complete:function(){c("sendAppMessage",{title:a.title||r,desc:a.desc||"",link:a.link||location.href,img_url:a.imgUrl||"",type:a.type||"link",data_url:a.dataUrl||""},a)}},a)},onMenuShareQQ:function(a){d(o.onMenuShareQQ,{complete:function(){c("shareQQ",{title:a.title||r,desc:a.desc||"",img_url:a.imgUrl||"",link:a.link||location.href},a)}},a)},onMenuShareWeibo:function(a){d(o.onMenuShareWeibo,{complete:function(){c("shareWeiboApp",{title:a.title||r,desc:a.desc||"",img_url:a.imgUrl||"",link:a.link||location.href},a)}},a)},onMenuShareQZone:function(a){d(o.onMenuShareQZone,{complete:function(){c("shareQZone",{title:a.title||r,desc:a.desc||"",img_url:a.imgUrl||"",link:a.link||location.href},a)}},a)},startRecord:function(a){c("startRecord",{},a)},stopRecord:function(a){c("stopRecord",{},a)},onVoiceRecordEnd:function(a){d("onVoiceRecordEnd",a)},playVoice:function(a){c("playVoice",{localId:a.localId},a)},pauseVoice:function(a){c("pauseVoice",{localId:a.localId},a)},stopVoice:function(a){c("stopVoice",{localId:a.localId},a)},onVoicePlayEnd:function(a){d("onVoicePlayEnd",a)},uploadVoice:function(a){c("uploadVoice",{localId:a.localId,isShowProgressTips:0==a.isShowProgressTips?0:1},a)},downloadVoice:function(a){c("downloadVoice",{serverId:a.serverId,isShowProgressTips:0==a.isShowProgressTips?0:1},a)},translateVoice:function(a){c("translateVoice",{localId:a.localId,isShowProgressTips:0==a.isShowProgressTips?0:1},a)},chooseImage:function(a){c("chooseImage",{scene:"1|2",count:a.count||9,sizeType:a.sizeType||["original","compressed"],sourceType:a.sourceType||["album","camera"]},function(){return a._complete=function(a){if(u){var b=a.localIds;b&&(a.localIds=JSON.parse(b))}},a}())},previewImage:function(a){c(o.previewImage,{current:a.current,urls:a.urls},a)},uploadImage:function(a){c("uploadImage",{localId:a.localId,isShowProgressTips:0==a.isShowProgressTips?0:1},a)},downloadImage:function(a){c("downloadImage",{serverId:a.serverId,isShowProgressTips:0==a.isShowProgressTips?0:1},a)},getNetworkType:function(a){var b=function(a){var c,d,e,b=a.errMsg;if(a.errMsg="getNetworkType:ok",c=a.subtype,delete a.subtype,c)a.networkType=c;else switch(d=b.indexOf(":"),e=b.substring(d+1)){case"wifi":case"edge":case"wwan":a.networkType=e;break;default:a.errMsg="getNetworkType:fail"}return a};c("getNetworkType",{},function(){return a._complete=function(a){a=b(a)},a}())},openLocation:function(a){c("openLocation",{latitude:a.latitude,longitude:a.longitude,name:a.name||"",address:a.address||"",scale:a.scale||28,infoUrl:a.infoUrl||""},a)},getLocation:function(a){a=a||{},c(o.getLocation,{type:a.type||"wgs84"},function(){return a._complete=function(a){delete a.type},a}())},hideOptionMenu:function(a){c("hideOptionMenu",{},a)},showOptionMenu:function(a){c("showOptionMenu",{},a)},closeWindow:function(a){a=a||{},c("closeWindow",{immediate_close:a.immediateClose||0},a)},hideMenuItems:function(a){c("hideMenuItems",{menuList:a.menuList},a)},showMenuItems:function(a){c("showMenuItems",{menuList:a.menuList},a)},hideAllNonBaseMenuItem:function(a){c("hideAllNonBaseMenuItem",{},a)},showAllNonBaseMenuItem:function(a){c("showAllNonBaseMenuItem",{},a)},scanQRCode:function(a){a=a||{},c("scanQRCode",{needResult:a.needResult||0,scanType:a.scanType||["qrCode","barCode"]},function(){return a._complete=function(a){var b,c;v&&(b=a.resultStr,b&&(c=JSON.parse(b),a.resultStr=c&&c.scan_code&&c.scan_code.scan_result))},a}())},openProductSpecificView:function(a){c(o.openProductSpecificView,{pid:a.productId,view_type:a.viewType||0,ext_info:a.extInfo},a)},addCard:function(a){var e,f,g,h,b=a.cardList,d=[];for(e=0,f=b.length;f>e;++e)g=b[e],h={card_id:g.cardId,card_ext:g.cardExt},d.push(h);c(o.addCard,{card_list:d},function(){return a._complete=function(a){var c,d,e,b=a.card_list;if(b){for(b=JSON.parse(b),c=0,d=b.length;d>c;++c)e=b[c],e.cardId=e.card_id,e.cardExt=e.card_ext,e.isSuccess=e.is_succ?!0:!1,delete e.card_id,delete e.card_ext,delete e.is_succ;a.cardList=b,delete a.card_list}},a}())},chooseCard:function(a){c("chooseCard",{app_id:z.appId,location_id:a.shopId||"",sign_type:a.signType||"SHA1",card_id:a.cardId||"",card_type:a.cardType||"",card_sign:a.cardSign,time_stamp:a.timestamp+"",nonce_str:a.nonceStr},function(){return a._complete=function(a){a.cardList=a.choose_card_info,delete a.choose_card_info},a}())},openCard:function(a){var e,f,g,h,b=a.cardList,d=[];for(e=0,f=b.length;f>e;++e)g=b[e],h={card_id:g.cardId,code:g.code},d.push(h);c(o.openCard,{card_list:d},a)},chooseWXPay:function(a){c(o.chooseWXPay,f(a),a)},startSearchBeacons:function(a){c(o.startSearchBeacons,{ticket:a.ticket},a)},stopSearchBeacons:function(a){c(o.stopSearchBeacons,{},a)},onSearchBeacons:function(a){d(o.onSearchBeacons,a)}},b&&(a.wx=a.jWeixin=C),C});


!( function( factory ){
  if (typeof define === "function" && define.amd ) {
    define( 'citySelect',factory );
  } else {
    factory();
  }
}( function() {

  var cityData;
  var initCitySelect = function( o ){

    var options = {
      eles: null,
      data: [],
      valname: "v",
      showname: "n",
      arrname: "s"
    };

    for (var key in o) {
      options[key] = o[key]
    }


    /**
     * *
     * @param  {[elements]}         eles  [The elements]
     * @param  {[object]}           data  [Current level's data]
     * @param  {[number]}           count [Current level]
     */
    var nextSelect = function(eles, data, count) {

      // Nothing to do, just return.
      if (data === undefined || data === null || data.length === 0 || !eles[count])
        return;


      var defaultVal = eles[count].getAttribute('data-default') || '--请选择--',
          html = '<option value="">' + defaultVal + '</option>',
          i,
          max;

      // Add current options & show it.
      for (i = 0, max = data.length; i < max; i++) {
        html += '<option value="' + data[i][options.valname] + '">'+ data[i][options.showname] + '</option>';
      }

      var temp = document.createElement("div");
      temp.innerHTML = html;
      [].slice.call(temp.children).forEach(function(child) {
        eles[count].appendChild(child);
      })

      eles[count].style.display = 'inline';

      // Unbind old handler & Bind select change event.
      //
      var changeHandler = function(){

        //$( eles[count] ).off();
        // need to remove listener???

        // Remove the greater level elements
        for (i = count + 1, max = eles.length; i < max; i++) {

          var ops = eles[i].querySelectorAll('option');
          eles[i].removeEventListener(changeHandler);

          [].slice.call(ops).forEach(function(ele){
            ele.remove();
          })
          eles[i].style.display = 'none';

        }

        // If you select -1, it means that you have not select any option. Do nothing.
        if (this.value === -1)
          return;

        for (i = 0, max = data.length; i < max; i++) {

          if (data[i][options.valname] == this.value) {

            nextSelect(eles, data[i][options.arrname], count + 1);
          }
        }
      }
      eles[count].addEventListener('change', changeHandler);

    };

    // Hide all elements.
    [].slice.call(options.eles).forEach(function(ele){
      ele.style.display = 'none';
    })

    // initCitySelect the first level.
    nextSelect(options.eles, options.data, 0);
  };

  var citySelect = function(eles, url) {

    eles  = (typeof eles === 'string') ? document.querySelectorAll(eles) : eles;
    url   = !url ? './city.min.json' : url;

    var _callback = false;

    // If had cityData.
    if (cityData) {

      initCitySelect({
        eles: eles,
        data: cityData
      })

      _callback = typeof _callback === 'function' ? _callback() : true;


    // No cityData, get it by ajax.
    } else {

      var xhr = new XMLHttpRequest()
      xhr.open("GET", url, true);
      xhr.onreadystatechange = function(){
        if (xhr.readyState === 4) {
          var json = JSON.parse(xhr.responseText);
          cityData = json;
          initCitySelect({
            eles: eles,
            data: json
          });
          _callback = typeof _callback === 'function' ? _callback() : true;

        }
      }
      xhr.send();

    }

    // Return selected function.
    return {
      selected: function(s) {

        // Make sure that city-json-data is loaded.
        if (_callback === false) {
          _callback = function() {
            for (var i = 0; i < s.length; i++) {
              eles[i].querySelector('option[value="'+ s[i]+'"]').selected = true;

              eles[i].dispatchEvent(new Event('change', {bubbles: true}))
              eles[i].onchange && eles[i].onchange();
            }
            return true;
          }
        } else {
          for (var i = 0; i < s.length; i++) {
            eles[i].querySelector('option[value="'+ s[i]+'"]').selected = true;

            eles[i].dispatchEvent(new Event('change', {bubbles: true}))
            eles[i].onchange && eles[i].onchange();
          }
        }
      }
    }

  };

  var init = function() {
    var role = document.querySelector('[data-role="citySelect"]');
    var namespace = '_';
    if (role && !role[namespace + 'inited']) {
      role[namespace + 'inited'] = true;
      role[namespace + 'selected'] = citySelect(role.querySelectorAll('select'), role.getAttribute('data-url')).selected;

      var selected = role.getAttribute('data-selected');
      if (selected) {
        selected = JSON.parse(selected);
        role[namespace + 'selected'](selected);
      }
    }
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init()
  } else {
    document.addEventListener('readystatechange', function(e) {
      if (document.readyState === 'interactive') {
        init();
      }
    })
  }

  document.addEventListener('reload', init)

  return null;

}));


!( function( factory ) {
  if ( typeof define === "function" && define.amd ) {
    define('formJSON',factory );
  } else {
    factory( );
  }
}(function( ){

  // Code form Zepto.js
  // @see https://github.com/madrobby/zepto/blob/master/src/form.js#files
  var serializeArray = function() {
    var name, type, result = [],
        add = function(value) {
          if (value.forEach) return value.forEach(add)
          result.push({ name: name, value: value })
        };

    [].slice.apply(this.elements).forEach(function(field) {

      type = field.type, name = field.name
      if (name && field.nodeName.toLowerCase() !== 'fieldset' &&
        !field.disabled && type !== 'submit' && type !== 'reset' && type !== 'button' && type !== 'file' &&
        ((type !== 'radio' && type !== 'checkbox') || field.checked))
          add(field.value)
    })
    return result
  }

  var serialize = function(){
    var result = []
    serializeArray.call(this).forEach(function(elm){
      result.push(encodeURIComponent(elm.name) + '=' + encodeURIComponent(elm.value))
    })
    return result.join('&')
  }
    /**
   * Set obj's value by keys
   * @param  {[object]}           obj   The target you want to set.
   * @param  {[array]}            keys  The value's path.
   * @param  {[string, array...]} value Target's value.
   * @return {[object]}                 The target after setting value.
   *
   * Example: obj = {'a':'a'}, keys = ['b','bb'], value = 'b-value'
   * return {
   *         'a': 'a',
   *         'b': {
   *           'bb': 'b-value'
   *          }
   *        }
   */
  var deepSet = function(obj, keys, value) {

    var curKey = keys[0];
    if(keys.length === 1) {

      curKey === '' ? obj.push(value) : obj[curKey] = value;

      return;
    }
    if (keys.length > 1) {
      if (typeof obj[curKey] === 'undefined')
        obj[curKey] = keys[1] === '' ? [] : {};
    }

    var o = obj[curKey];
    keys.shift();
    return deepSet(o, keys, value);
  }

  var integerKeysAsArrayIndexes = function(obj, keys, value) {

    var allKeysIsInteger = true;
    var arr = [];
    var temp;
    keys = keys || [];
    value = value || obj;



    for (var key in value) {

      temp = keys.concat();

      if (isNaN(+key)) {
        allKeysIsInteger = false;
      } else {
        arr.push(value[key]);
      }
      temp.push(key);

      if ((typeof value[key] === 'object') && !Array.isArray(value[key])) {
        integerKeysAsArrayIndexes(obj, temp, value[key]);
      }
    }

    if (allKeysIsInteger) {

      if (keys.length === 0) {
        obj = arr;
      } else {
        deepSet(obj, keys, arr)
      }
    }
    return obj;
  }
  // TEST: integerKeysAsArrayIndexes
  // var json = integerKeysAsArrayIndexes({
  //   a: {
  //     0: {
  //       aa: "aa",
  //       bb: {
  //         0: "bb0",
  //         1: "bb1",
  //         3: "bb3"
  //       }
  //     },
  //     1: "a"
  //   },
  //   b: "b"
  // })
  // console.log(JSON.stringify(json));
  // var json = integerKeysAsArrayIndexes({
  //   0: "a",
  //   1: {
  //     "a": "b"
  //   }
  // })
  // console.log(JSON.stringify(json));


  // keys: ["a", ""]
  // ["a", "b", "c"], ["a", "b", "d"]
  // types: "string", "array", "number", "bool", "object"
  //
  // TEST
  // form.json
  // input(name='a')
  // input(name='images.')
  // input(name='images.')
  // input(name='b.b')
  // input(name='c.c.:number')
  // input(name='c.c.')
  // input(type='submit')
  //
  var submitHandler = function(e, options, action) {

    var self = this;
    var method = self.getAttribute('method') || 'POST';
    var res;

    if (method === "GET") {
      res = serialize.call(self);
    } else {

      res = {};
      serializeArray.call(self).forEach(function(t){
        var keys  = t.name.split('.');
        var len   = keys.length - 1;
        var index = keys[len].indexOf(':');
        var value = t.value;
        var type;
        if (index !== -1) {
          type    = keys[len].substr(index + 1);
          keys[len] = keys[len].substr(0, index);
        } else {
          type = 'string';
        }

        if (type === 'array' || type === 'object') {

          value  = JSON.parse(value);

        } else if (type === 'number') {

          value = +value;

        } else if (type === 'time') {
          value = new Date(value).getTime();

        } else if (type === 'bool' || type === 'boolean') {
          if (value === 'false')
            value = false
          else
            value = !!value;

        }

        deepSet(res, keys, value);
      });

      if (options.parseInteger)
        res = integerKeysAsArrayIndexes(res);
      res = options.data.call(self, res);
      res = JSON.stringify(res);
    }

    /**
     * If there are no data should be sent, just return.
     */
    if (res === 'null') {
      return;
    }

    /**
     *
     * AJAX request
     *
     */
    var xmlHttp = new XMLHttpRequest();
    /**
     * Add session header for cross-domain request.
     * You can't set cookies for ajax
     * and you have to response #options request# like:
     * "Access-Control-Allow-Headers: X-AVOSCloud-Session-Token"
     * before you send it.
     * */
    var session = document.cookie.match(/sessionToken=([^;]*)(;|$)/);
    action = (action === undefined ? self.getAttribute('action') : action);

    if (method === 'GET') {
      action += action.indexOf('?') === -1 ? ('?' + res) : ( '&' + res);
    }

    xmlHttp.open(method, action, true);
    xmlHttp.setRequestHeader('Content-Type', 'application/json');
    if (session) {
      xmlHttp.setRequestHeader('X-AVOSCloud-Session-Token', session[1])
    }

    xmlHttp.responseType = 'json';

    xmlHttp.onreadystatechange = function() {
      if (xmlHttp.readyState === 4) {
        if (xmlHttp.status >= 200 && xmlHttp.status < 300) {

          if (typeof xmlHttp.response === 'string')
            options.ended.call(self, JSON.parse(xmlHttp.response), xmlHttp);
          else
            options.ended.call(self, xmlHttp.response, xmlHttp);

        } else {
          options.error.call(self, xmlHttp);
        }
      }
    }

    if (method === 'GET')
      xmlHttp.send();
    else
      xmlHttp.send(res);
  }




  /**
   * Example:
   * <form action='/action/a'>
   * <input type='submit'>
   * <input type='submit' formAction='/action/b'>
   * </form>
   */
  var formAction;
  document.addEventListener('click', function(e) {
    var target = e.target;

    if (target.type === 'submit' && target.formAction) {
      formAction = target.formAction;
    }

    setTimeout(function() {
      formAction = undefined;
    }, 1000);

  })

  /**
   * Submit form's handler.
   * Example:
   * <form data-role='formJSON'>
   * </form>
   */
  document.addEventListener('submit', function(e) {

    var target = e.target;
    if (target.getAttribute('data-role') === 'formJSON') {

      e.preventDefault();

      var temp = (temp = target.getAttribute('data-target')) && document.querySelector(temp);
      var parseInteger = target.getAttribute('data-parseInteger') === 'false' ? false : true;

      var options = {
        parseInteger: parseInteger,
        ended: target.onended || ( temp && temp.onended ) || function(){},
        // to change data
        data: target._data || ( temp && temp._data ) || function(d){return d},
        error: target.onerror || ( temp && temp.onerror ) || function(){}
      };

      submitHandler.call(target, e, options, formAction);

    }

  })

  // Fix.
  // Submit a form by javascript won't fire submit event.
  // @see http://stackoverflow.com/questions/12819357/form-submitted-using-submit-from-a-link-cannot-be-caught-by-onsubmit-handler

  var _submit = HTMLFormElement.prototype.submit;
  HTMLFormElement.prototype.submit = function() {

    if (this.getAttribute('data-role') === 'formJSON') {
      this.dispatchEvent(new Event('submit', {bubbles: true}));
    } else {
      _submit.call(this);
    }
  }

  return null;

}));


;( function( factory ) {
  if ( typeof define === "function" && define.amd ) {
    define('shareWX',["jweixin" ], factory );
  } else {
    factory( wx );
  }
}( function(wx){

  var options = {

    /**
     *
     * Sign url api ( You can use [wechat.js](https://github.com/zhoukekestar/modules-nodejs/blob/master/lib/wechat.js) to response the request. ) :
     *
     * Example:
     * Request: /wechat/sdk/sign?url=http%3A%2F%2F223.95.81.53%3A23002%2Fshop%2Fevent%2F1
     * Response: {"url":"http://223.95.81.53:23002/shop/event/1","appId":"wx7d7b73a6b545f4d4","timestamp":1438830027313,"nonceStr":"2265","signature":"3f0a4edbd91d814faaf6f99b785d88e2ecaf98e8"}
     *
     */
    api       : '/wechat/sdk/sign',
    debug     : false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。

    // Url config
    appId     : '', // 必填，公众号的唯一标识
    timestamp : 0 , // 必填，生成签名的时间戳
    nonceStr  : '', // 必填，生成签名的随机串
    signature : '', // 必填，签名，见附录1

    // Share config
    title   : "",
    desc    : "",
    link    : "",
    imgUrl  : "",
    success : function(){},
    cancel  : function(){},

    jsApiList: [
      'checkJsApi',
      'onMenuShareTimeline',
      'onMenuShareAppMessage',
      'onMenuShareQQ',
      'onMenuShareWeibo',
      'hideMenuItems',
      'showMenuItems',
      'hideAllNonBaseMenuItem',
      'showAllNonBaseMenuItem',
      'translateVoice',
      'startRecord',
      'stopRecord',
      'onRecordEnd',
      'playVoice',
      'pauseVoice',
      'stopVoice',
      'uploadVoice',
      'downloadVoice',
      'chooseImage',
      'previewImage',
      'uploadImage',
      'downloadImage',
      'getNetworkType',
      'openLocation',
      'getLocation',
      'hideOptionMenu',
      'showOptionMenu',
      'closeWindow',
      'scanQRCode',
      'chooseWXPay',
      'openProductSpecificView',
      'addCard',
      'chooseCard',
      'openCard'
    ]
  }


  var shareWX= function(o) {

    for (var key in o) { options[key] = o[key] }

    var xmlHttp = new XMLHttpRequest()
    xmlHttp.open("GET", options.api + '?url=' + encodeURIComponent(location.href.split('#')[0]), true);
    xmlHttp.onreadystatechange = function(){
      if (xmlHttp.readyState === 4) {
        var d = JSON.parse(xmlHttp.responseText);

        for (var key in d) { options[key] = d[key] }

        wx.config(options);

        wx.ready(function(){

          if (options.hide) {

            wx.hideOptionMenu();
          }

          share(wx, options);
        })
      }
    }
    xmlHttp.send(null);
  };


  function share(wx, options) {

    wx.onMenuShareTimeline({
        title: options.title, // 分享标题
        link: options.link, // 分享链接
        imgUrl: options.imgUrl, // 分享图标
        success: options.success,
        cancel: options.cancel
    });

    wx.onMenuShareAppMessage({
        title: options.title, // 分享标题
        desc: options.desc, // 分享描述
        link: options.link, // 分享链接
        imgUrl: options.imgUrl, // 分享图标
        success: options.success,
        cancel: options.cancel
    });
    wx.onMenuShareQQ({
      title: options.title, // 分享标题
        desc: options.desc, // 分享描述
        link: options.link, // 分享链接
        imgUrl: options.imgUrl, // 分享图标
        success: options.success,
        cancel: options.cancel
    });
    wx.onMenuShareWeibo({
      title: options.title, // 分享标题
        desc: options.desc, // 分享描述
        link: options.link, // 分享链接
        imgUrl: options.imgUrl, // 分享图标
        success: options.success,
        cancel: options.cancel
    });
  }

  var init = function(force) {
    var namespace = '_';
    var role = document.querySelector('[data-role=shareWX]');

    if (role && (!role[namespace + 'inited'] || force)) {
      role[namespace + 'inited'] = true;

      var data = {
        hide: !!role.getAttribute('data-hide'),
        title: role.getAttribute('data-title'),
        desc: role.getAttribute('data-desc'),
        link: role.getAttribute('data-link'),
        imgUrl: role.getAttribute('data-imgUrl'),
        debug: !!role.getAttribute('data-debug'),
        success: role[namespace + 'success'],
        cancel: role[namespace + 'cancel']
      }

      shareWX(data)

      role[namespace + 'wx'] = wx;
    }
  }

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    init()
  } else {
    document.addEventListener('readystatechange', function(e) {
      if (document.readyState === 'interactive') {
        init();
      }
    })
  }

  document.addEventListener('reload', function(){
    init(true);
  })

}));

